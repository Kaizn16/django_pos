{% extends "layouts/base.html" %}
{% load static %}
{% block 'title' %} Sales {% endblock 'title' %}
{% block 'content' %}
<section class="w-full h-auto p-2 flex flex-col gap-3">
    <div class="flex lg:flex-row flex-col bg-white">
        <div class="w-full lg:w-3/5 md:min-h-screen shadow-md h-full">
          <!-- header -->
          <div class="flex flex-row justify-between items-center px-5 mt-5">
            <div class="text-gray-800">
              <div class="font-bold text-xl">POS</div>
              <span class="text-xs">FCU-CCS</span>
            </div>
          </div>
          <!-- end header -->
        
          <section class="mt-5 px-5">
            <div class="flex flex-col sm:flex-row sm:items-center gap-4">
              <!-- Scrollable category list -->
              <div class="relative w-full sm:w-52 md:w-full">
                <!-- Left Arrow -->
                <div id="leftArrow" class="absolute left-0 top-1/2 -translate-y-1/2 z-10 dark:bg-gray-500 text-white p-1 rounded-full shadow hidden cursor-pointer">
                  <i class="material-icons">chevron_left</i>
                </div>  

                <div id="categoryScroll" class="flex overflow-x-auto gap-2 sm:gap-4 p-4 scrollbar-thin scrollbar-thumb-gray-200 scroll-smooth sm:w-52 md:w-full w-full">
                  <span data-category="all" class="whitespace-nowrap px-5 py-1 dark:bg-gray-500 rounded-2xl text-white text-sm mr-1 cursor-pointer">All items</span>
                  {% for category in categories %}
                  <span data-category="{{ category.category_id }}" class="whitespace-nowrap px-5 py-1 rounded-2xl text-sm font-semibold mr-1 cursor-pointer">{{ category.category_name }}</span>
                  {% endfor %}
                </div>

                <!-- Right Arrow -->
                <div id="rightArrow" class  ="absolute right-0 top-1/2 -translate-y-1/2 z-10 dark:bg-gray-500 text-white p-1 rounded-full shadow cursor-pointer">
                  <i class="material-icons">chevron_right</i>
                </div>
              </div>

              <!-- Search input -->
              <div class="relative w-full sm:w-80">
                <label for="search" class="sr-only">Search</label>
                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                  <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 20 20" aria-hidden="true">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z" />
                  </svg>
                </div>
                <input type="text" id="search"
                  class="block w-full p-2 pl-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                  placeholder="Search">
              </div>
            </div>
          </section>
          <!-- loader -->
           {% include 'components/loader.html' %}
           <!-- loader -->
          <!-- products -->
          <div id="product-grid" class="grid grid-cols-1 gap-4 px-5 mt-5 overflow-y-auto h-80 sm:grid-cols-3 md:h-3/4">
            <!-- Dynamic product cards will be inserted here -->
          </div>
          <!-- end products -->

        </div>
        <!-- end left section -->

        <!-- right section -->
        <div class="w-full lg:w-2/5">
          <!-- header -->
          <div class="flex flex-wrap flex-row items-center justify-between px-5 mt-5 gap-2">
            <div class="font-bold text-xl">Cart</div>
            <div class="flex flex-wrap flex-row gap-2 font-semibold">
              <span class="px-4 py-2 rounded-md bg-red-100 text-red-500">Clear All</span>
              <span class="px-4 py-2 rounded-md bg-red-100 text-red-500">Settings</span>
            </div>
          </div>
          <!-- end header -->

          <!-- cart list -->
          <div class="px-5 py-4 mt-5 overflow-y-auto h-64">
              <div class="flex flex-row justify-between items-center mb-4">
                <div class="flex flex-row items-center w-2/5">
                  <img src="https://source.unsplash.com/4u_nRgiLW3M/600x600" class="w-10 h-10 object-cover rounded-md" alt="">
                  <span class="ml-4 font-semibold text-sm">Stuffed flank steak</span>
                </div>
                <div class="w-32 flex justify-between">
                  <span class="px-3 py-1 rounded-md bg-gray-300 ">-</span>
                  <span class="font-semibold mx-4">2</span>
                  <span class="px-3 py-1 rounded-md bg-gray-300 ">+</span>
                </div>
                <div class="font-semibold text-lg w-16 text-center">
                  ₱13.50
                </div>
              </div>             
              <div class="flex flex-row justify-between items-center mb-4">
                <div class="flex flex-row items-center w-2/5">
                  <img src="https://source.unsplash.com/sc5sTPMrVfk/600x600" class="w-10 h-10 object-cover rounded-md" alt="">
                  <span class="ml-4 font-semibold text-sm">Grilled Corn</span>
                </div>
                <div class="w-32 flex justify-between">
                  <span class="px-3 py-1 rounded-md bg-gray-300 ">-</span>
                  <span class="font-semibold mx-4">10</span>
                  <span class="px-3 py-1 rounded-md bg-gray-300 ">+</span>
                </div>
                <div class="font-semibold text-lg w-16 text-center">
                  ₱3.50
                </div>
              </div>
              <div class="flex flex-row justify-between items-center mb-4">
                <div class="flex flex-row items-center w-2/5">
                  <img src="https://source.unsplash.com/MNtag_eXMKw/600x600" class="w-10 h-10 object-cover rounded-md" alt="">
                  <span class="ml-4 font-semibold text-sm">Grilled Corn</span>
                </div>
                <div class="w-32 flex justify-between">
                  <span class="px-3 py-1 rounded-md bg-gray-300 ">-</span>
                  <span class="font-semibold mx-4">10</span>
                  <span class="px-3 py-1 rounded-md bg-gray-300 ">+</span>
                </div>
                <div class="font-semibold text-lg w-16 text-center">
                  ₱3.50
                </div>
              </div>
              <div class="flex flex-row justify-between items-center mb-4">
                <div class="flex flex-row items-center w-2/5">
                  <img src="https://source.unsplash.com/MNtag_eXMKw/600x600" class="w-10 h-10 object-cover rounded-md" alt="">
                  <span class="ml-4 font-semibold text-sm">Grilled Corn</span>
                </div>
                <div class="w-32 flex justify-between">
                  <span class="px-3 py-1 rounded-md bg-gray-300 ">-</span>
                  <span class="font-semibold mx-4">10</span>
                  <span class="px-3 py-1 rounded-md bg-gray-300 ">+</span>
                </div>
                <div class="font-semibold text-lg w-16 text-center">
                  ₱3.50
                </div>
              </div> 
              <div class="flex flex-row justify-between items-center mb-4">
                <div class="flex flex-row items-center w-2/5">
                  <img src="https://source.unsplash.com/MNtag_eXMKw/600x600" class="w-10 h-10 object-cover rounded-md" alt="">
                  <span class="ml-4 font-semibold text-sm">Ranch Burger</span>
                </div>
                <div class="w-32 flex justify-between">
                  <span class="px-3 py-1 rounded-md bg-red-300 text-white">x</span>
                  <span class="font-semibold mx-4">1</span>
                  <span class="px-3 py-1 rounded-md bg-gray-300 ">+</span>
                </div>
                <div class="font-semibold text-lg w-16 text-center">
                  ₱2.50
                </div>
              </div> 
              <div class="flex flex-row justify-between items-center mb-4">
                <div class="flex flex-row items-center w-2/5">
                  <img src="https://source.unsplash.com/4u_nRgiLW3M/600x600" class="w-10 h-10 object-cover rounded-md" alt="">
                  <span class="ml-4 font-semibold text-sm">Ranch Burger</span>
                </div>
                <div class="w-32 flex justify-between">
                  <span class="px-3 py-1 rounded-md bg-red-300 text-white">x</span>
                  <span class="font-semibold mx-4">1</span>
                  <span class="px-3 py-1 rounded-md bg-gray-300 ">+</span>
                </div>
                <div class="font-semibold text-lg w-16 text-center">
                  ₱2.50
                </div>
              </div>            
          </div>
          <!-- end cart list -->
          <!-- totalItems -->
          <div class="px-5 mt-5">
            <div class="py-4 rounded-md shadow-lg">
              <div class=" px-4 flex justify-between ">
                <span class="font-semibold text-sm">Subtotal</span>
                <span class="font-bold">₱35.25</span>
              </div>
              <div class=" px-4 flex justify-between ">
                <span class="font-semibold text-sm">Discount</span>
                <span class="font-bold">- ₱5.00</span>
              </div>
              <div class=" px-4 flex justify-between ">
                <span class="font-semibold text-sm">Sales Tax</span>
                <span class="font-bold">₱2.25</span>
              </div>
              <div class="border-t-2 mt-3 py-2 px-4 flex items-center justify-between">
                <span class="font-semibold text-2xl">Total</span>
                <span class="font-bold text-2xl">₱37.50</span>
              </div>
            </div>
          </div>
          <!-- end total -->
          <!-- button pay-->
          <div class="px-5 mt-5 mb-5">
            <button class="flex items-center justify-center gap-2 px-4 py-4 rounded-md shadow-lg text-center bg-blue-500 text-white font-semibold w-full hover:bg-blue-400 cursor-pointer">
              <i class="material-icons">payments</i>
              CHECKOUT
            </button>
          </div>
          <!-- end button pay -->
        </div>
        <!-- end right section -->
    </div>

    <!--ADDING CART MODAL-->
    <div id="productSelectModal" class="fixed inset-0 z-50 hidden flex items-center justify-center" style="background: rgba(0, 0, 0, 0.8);">
      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md shadow-lg">
        <h2 class="text-lg font-semibold text-gray-800 dark:text-white">Product Selected</h2>
        <form id="productSelectForm" class="mt-4 space-y-4" method="post" action="">
          <input type="hidden" name="_csrf_token" value="{{ csrf_token }}">
          <input type="hidden" id="selectedProductId" name="product_id">
          <div class="flex flex-col gap-3 mb-6">
            <div class="w-full flex justify-center items-center">
              <img src="" id="selectedProductImage" alt="Selected Product Preview" class="w-32 h-32">
            </div>
            <section>
              <div class="dark:text-white flex gap-1">
                <strong>Name:</strong> 
                <p id="selectedProductName" class="font-light"></p>
              </div>
              <div class="dark:text-white flex gap-1">
                <strong>Category:</strong> 
                <p id="selectedProductCategory" class="font-light"></p>
              </div>
              <div class="dark:text-white flex gap-1">
                <strong>Price:</strong> 
                <p id="selectedProductPrice" class="font-light"></p>
              </div>
            </section>
          </div>
          <div class="mb-6">
            <label for="productQuantity" class="block text-gray-700 dark:text-gray-300 text-sm font-medium mb-1">Quantity</label>
            <input type="number" id="productQuantity" name="quantity" min="1" required
              class="w-full px-3 py-2 border border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div class="flex justify-end gap-2">
            <button type="button" id="cancelProductSelect"
              class="px-4 py-2 bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-white rounded hover:bg-gray-400">
              Cancel
            </button>
            <button type="submit"
              class="flex items-center px-4 py-2 bg-blue-500 text-white rounded cursor-pointer hover:bg-blue-600">
              <i class="material-icons">shopping_cart</i> Add to Cart
            </button>
          </div>
        </form>
      </div>
    </div>
    <!--ADDING CART MODAL-->

</section>
<script>
  const scrollContainer = document.getElementById("categoryScroll");
  const leftArrow = document.getElementById("leftArrow");
  const rightArrow = document.getElementById("rightArrow");

  function updateArrows() {
    const maxScrollLeft = scrollContainer.scrollWidth - scrollContainer.clientWidth;
    leftArrow.style.display = scrollContainer.scrollLeft > 0 ? 'block' : 'none';
    rightArrow.style.display = scrollContainer.scrollLeft < maxScrollLeft ? 'block' : 'none';
  }

  leftArrow.onclick = () => {
    scrollContainer.scrollBy({ left: -100, behavior: 'smooth' });
  };

  rightArrow.onclick = () => {
    scrollContainer.scrollBy({ left: 100, behavior: 'smooth' });
  };

  scrollContainer.addEventListener('scroll', updateArrows);

  window.addEventListener('load', updateArrows);
</script>
<script>
  let currentSearch = '';
  let currentCategory = '';
  let currentPage = 1; // If you need pagination

  async function renderProducts(search = '', category = '') {
    const loader = document.getElementById("loader");
    const productGrid = document.getElementById("product-grid");

    loader.classList.remove("hidden");
    productGrid.classList.add("hidden");
    productGrid.innerHTML = '';

    const query = new URLSearchParams({
      search: search,
      category: category,
    });

    try {
      const response = await fetch(`/api/sales/products?${query.toString()}`);
      const products = await response.json();

      if (!products.length) {
        productGrid.innerHTML = `<p class="text-center w-full text-gray-500">No products found.</p>`;
      }

      products.forEach(product => {
        const productCard = document.createElement('div');
        productCard.className = 'relative px-3 py-3 flex flex-col border border-gray-200 rounded-md h-32 justify-between cursor-pointer hover:bg-gray-300';
        productCard.dataset.productData = JSON.stringify(product);

        const STOCK_PERCENTAGE = (product.stock / product.max_stock) * 100;

        let colorClass = '';

        if (STOCK_PERCENTAGE === 100 || STOCK_PERCENTAGE >= 80) {
          colorClass = 'bg-green-500';
        } else if (STOCK_PERCENTAGE > 10 && STOCK_PERCENTAGE <= 50) {
          colorClass = 'bg-yellow-400';
        } else if (STOCK_PERCENTAGE > 0 && STOCK_PERCENTAGE <= 10) {
          colorClass = 'bg-red-500';
        } else {
          colorClass = 'dark:bg-gray-500';
        }

        productCard.innerHTML = `
          <div class="absolute top-1 right-2 text-xs font-semibold px-2 py-0.5 rounded-full ${colorClass} text-white">
            ${product.stock > 0 ? product.stock : '0'}
          </div>
          <div class="p-1">
            <div class="font-bold text-gray-800">${product.product_name}</div>
          </div>
          <div class="flex flex-row justify-between items-center">
            <span class="self-end font-bold text-lg dark:text-gray-500">₱${product.price}</span>
            <img src="${product.image || '/static/images/default-product.png'}" class="h-14 w-14 object-cover rounded-md" alt="${product.product_name}">
          </div>
        `;

        productGrid.appendChild(productCard);

        // Product click handler
        productCard.addEventListener('click', () => {
            const productData = JSON.parse(productCard.dataset.productData);

            document.getElementById("selectedProductId").value = productData.id;
            document.getElementById("selectedProductImage").src = productData.image;
            document.getElementById("selectedProductName").innerHTML = productData.product_name;
            document.getElementById("selectedProductCategory").innerHTML = productData.category;
            document.getElementById("selectedProductPrice").innerHTML = productData.price;
            document.getElementById("productQuantity").value = '';

            // Show the modal
            document.getElementById("productSelectModal").classList.remove("hidden");
        });

      });

      loader.classList.add("hidden");
      productGrid.classList.remove("hidden");

    } catch (error) {
      console.error("Failed to fetch products:", error);
      loader.classList.add("hidden");
      productGrid.innerHTML = `<p class="text-red-500 text-center w-full">Failed to load products.</p>`;
      productGrid.classList.remove("hidden");
    }
  }

  const searchInput = document.getElementById('search');
  const categoryItems = document.querySelectorAll("#categoryScroll span");
  let debounceTimer;

  // Debounced Search Input
  searchInput.addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      currentSearch = searchInput.value.trim();
      currentPage = 1;
      renderProducts(currentSearch, currentCategory);
    }, 600);
  });

  // Category click handler when selected
  categoryItems.forEach((item) => {
    item.addEventListener("click", function () {
      currentCategory = this.getAttribute("data-category");

      // Highlight the selected category
      categoryItems.forEach(el => el.classList.remove("dark:bg-gray-500", "text-white"));
      this.classList.add("dark:bg-gray-500", "text-white");

      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        renderProducts(currentSearch, currentCategory);
      }, 600);
    });
  });

  // Intialized load products
  document.addEventListener("DOMContentLoaded", () => {
    renderProducts();
  });

  document.getElementById("cancelProductSelect").addEventListener("click", () => {
    document.getElementById("productSelectModal").classList.add("hidden");
  });

  document.getElementById("productSelectForm").addEventListener("submit", function(e) {
    e.preventDefault();
    
    const productId = document.getElementById("selectedProductId").value;
    const quantity = document.getElementById("productQuantity").value;

    console.log("Selected Product:", productId, "Quantity:", quantity);
    document.getElementById("productSelectModal").classList.add("hidden");

    renderProducts();
  });

</script>
{% endblock 'content' %}